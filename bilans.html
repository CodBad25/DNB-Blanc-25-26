<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNB Blanc 25-26 - Bilans & R√©sultats</title>
    <!-- SheetJS pour lecture Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF pour g√©n√©ration PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas pour capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- html2pdf pour g√©n√©ration PDF simple -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Chart.js pour graphiques interactifs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/bilans.css?v=20260117016">
</head>
<body>
    <div class="app-container">
        <!-- Header compact -->
        <header class="app-header">
            <a href="index.html" class="back-link">‚Üê Retour</a>
            <div class="header-content">
                <div class="header-icon">üìä</div>
                <h1>Bilans & R√©sultats</h1>
                <p class="header-subtitle">DNB Blanc - D√©cembre 2025</p>
            </div>
            <div style="width:70px;"></div>
        </header>

        <!-- Navigation par onglets/√©tapes -->
        <nav class="tabs-nav">
            <button class="tab-btn active" data-tab="import" onclick="switchTab('import')">
                <span class="tab-number">1</span>
                <span class="tab-label">Import</span>
                <span class="tab-sublabel">Donn√©es sources</span>
            </button>
            <button class="tab-btn" data-tab="overview" onclick="switchTab('overview')" disabled>
                <span class="tab-number">2</span>
                <span class="tab-label">Vue d'ensemble</span>
                <span class="tab-sublabel">Statistiques globales</span>
            </button>
            <button class="tab-btn" data-tab="students" onclick="switchTab('students')" disabled>
                <span class="tab-number">3</span>
                <span class="tab-label">√âl√®ves</span>
                <span class="tab-sublabel">R√©sultats d√©taill√©s</span>
            </button>
            <button class="tab-btn" data-tab="generate" onclick="switchTab('generate')" disabled>
                <span class="tab-number">4</span>
                <span class="tab-label">G√©n√©ration</span>
                <span class="tab-sublabel">PDF & Export</span>
            </button>
        </nav>

        <!-- Contenu des onglets -->
        <main class="tab-content">

            <!-- ONGLET 1: IMPORT -->
            <section class="tab-panel active" id="tab-import">
                <div class="panel-header">
                    <h2>üì• Import des donn√©es</h2>
                    <p>Importez les corrections et la liste des √©l√®ves pour g√©n√©rer les bilans</p>
                </div>

                <div class="import-grid">
                    <!-- Import JSON -->
                    <div class="import-card" id="importCardJSON">
                        <div class="import-card-header">
                            <span class="import-step">1</span>
                            <div class="import-card-title">
                                <h3>Corrections</h3>
                                <p>Fichier JSON export√© depuis l'app</p>
                            </div>
                            <span class="import-status" id="jsonStatus">Non import√©</span>
                        </div>

                        <div class="import-card-body" id="jsonDropzone">
                            <div class="dropzone" id="dropzoneJSON">
                                <div class="dropzone-icon">üìã</div>
                                <p class="dropzone-title">D√©posez le fichier JSON</p>
                                <p class="dropzone-hint">ou cliquez pour parcourir</p>
                                <input type="file" id="jsonInput" accept=".json" hidden>
                            </div>
                        </div>

                        <div class="import-card-success" id="jsonSuccess" style="display:none;">
                            <div class="success-icon">‚úÖ</div>
                            <div class="success-info">
                                <strong id="jsonCount">0 candidats</strong>
                                <span>corrig√©s</span>
                            </div>
                            <button class="btn-modify" onclick="resetCorrections()">Modifier</button>
                        </div>
                    </div>

                    <!-- Import CSV/Excel -->
                    <div class="import-card" id="importCardCSV">
                        <div class="import-card-header">
                            <span class="import-step">2</span>
                            <div class="import-card-title">
                                <h3>Liste des √©l√®ves</h3>
                                <p>Fichier CSV ou Excel pour d√©sanonymat</p>
                            </div>
                            <span class="import-status" id="csvStatus">Non import√©</span>
                        </div>

                        <div class="import-card-body" id="csvDropzone">
                            <div class="dropzone" id="dropzone">
                                <div class="dropzone-icon">üìÅ</div>
                                <p class="dropzone-title">D√©posez le fichier CSV/Excel</p>
                                <p class="dropzone-hint">Colonnes : num√©ro, nom, pr√©nom, classe</p>
                                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" hidden>
                            </div>
                        </div>

                        <div class="import-card-success" id="csvSuccess" style="display:none;">
                            <div class="success-icon">‚úÖ</div>
                            <div class="success-info">
                                <strong id="csvCount">0 √©l√®ves</strong>
                                <span id="csvClasses">import√©s</span>
                            </div>
                            <button class="btn-modify" onclick="resetImport()">Modifier</button>
                        </div>
                    </div>
                </div>

                <!-- Aper√ßu avant validation -->
                <div class="preview-card" id="previewSection" style="display:none;">
                    <h3>Aper√ßu des donn√©es</h3>
                    <div class="preview-stats">
                        <span><strong id="totalEleves">0</strong> √©l√®ves</span>
                        <span><strong id="totalClasses">0</strong> classes</span>
                    </div>
                    <div class="preview-table-wrap">
                        <table class="preview-table">
                            <thead>
                                <tr><th>N¬∞</th><th>Nom</th><th>Pr√©nom</th><th>Classe</th></tr>
                            </thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                    <div class="preview-actions">
                        <button class="btn-secondary" onclick="cancelImport()">Annuler</button>
                        <button class="btn-primary" onclick="confirmImport()">‚úì Valider l'import</button>
                    </div>
                </div>

                <!-- Bouton continuer -->
                <div class="import-actions" id="importActions" style="display:none;">
                    <button class="btn-continue" onclick="switchTab('overview')">
                        Continuer vers les analyses ‚Üí
                    </button>
                </div>
            </section>

            <!-- ONGLET 2: VUE D'ENSEMBLE -->
            <section class="tab-panel" id="tab-overview">
                <!-- Header + Filtre -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                    <div class="panel-header" style="margin-bottom:0;">
                        <h2>üìä Vue d'ensemble</h2>
                    </div>
                    <div class="filter-bar">
                        <label>Classe :</label>
                        <div class="class-chips" id="classChips">
                            <button class="chip active" data-class="all" onclick="selectClass('all')">Toutes</button>
                        </div>
                    </div>
                </div>

                <!-- Stats rapides -->
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statMoyenne">--</div>
                            <div class="stat-label">Moyenne</div>
                        </div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statMediane">--</div>
                            <div class="stat-label">M√©diane</div>
                        </div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-icon">üìè</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statEtendue">--</div>
                            <div class="stat-label">√âtendue</div>
                        </div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-content">
                            <div class="stat-value" id="statChampion">--</div>
                            <div class="stat-label" id="statChampionName">Meilleure note</div>
                        </div>
                    </div>
                </div>

                <!-- Graphiques - Ligne 1 -->
                <div class="charts-row">
                    <div class="chart-card">
                        <h3>R√©partition des notes</h3>
                        <p class="chart-subtitle">Distribution par tranches de 2 points</p>
                        <div class="chart-container"><canvas id="distributionChartCanvas"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3>Niveaux de ma√Ætrise</h3>
                        <p class="chart-subtitle">R√©partition des √©l√®ves</p>
                        <div class="chart-container"><canvas id="masteryChartCanvas"></canvas></div>
                    </div>
                </div>

                <!-- Graphiques - Ligne 2 -->
                <div class="charts-row">
                    <div class="chart-card">
                        <h3>Performance par exercice</h3>
                        <p class="chart-subtitle">Taux de r√©ussite moyen</p>
                        <div class="chart-container"><canvas id="exerciseChartCanvas"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h3>Dispersion des notes</h3>
                        <p class="chart-subtitle">Min, Q1, M√©diane, Q3, Max</p>
                        <div class="chart-container" id="boxPlotContainer"></div>
                    </div>
                </div>

                <!-- D√©tail par exercice -->
                <div class="detail-exercices-section">
                    <h3>üìã D√©tail par exercice</h3>
                    <p class="chart-subtitle">Score moyen et taux de r√©ussite</p>
                    <div class="exercise-detail-grid" id="exerciseDetailGrid"></div>
                </div>

                <!-- Recommandations p√©dagogiques -->
                <div class="recommendations-section">
                    <h3>üéØ Recommandations p√©dagogiques</h3>
                    <p class="chart-subtitle">Bas√©es sur les performances des √©l√®ves</p>
                    <div class="recommendation-grid" id="recommendationGrid"></div>
                </div>
            </section>

            <!-- ONGLET 3: √âL√àVES -->
            <section class="tab-panel" id="tab-students">
                <div class="panel-header">
                    <h2>üë• R√©sultats des √©l√®ves</h2>
                    <p>Liste d√©taill√©e avec notes et niveaux de ma√Ætrise</p>
                </div>

                <!-- Filtre et recherche -->
                <div class="toolbar">
                    <div class="class-chips" id="classChips2">
                        <button class="chip active" data-class="all" onclick="selectClass('all')">Toutes</button>
                    </div>
                    <input type="text" class="search-input" id="searchStudents" placeholder="üîç Rechercher un √©l√®ve..." oninput="filterStudentsTable()">
                </div>

                <!-- Tableau des r√©sultats -->
                <div class="results-table-container">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>N¬∞</th>
                                <th>Nom Pr√©nom</th>
                                <th>Classe</th>
                                <th>Note /20</th>
                                <th>Niveau</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
                <div class="no-results" id="noResults" style="display:none;">
                    <span class="no-results-icon">üì≠</span>
                    <p>Aucun r√©sultat trouv√©</p>
                </div>
            </section>

            <!-- ONGLET 4: G√âN√âRATION -->
            <section class="tab-panel" id="tab-generate">
                <div class="panel-header">
                    <h2>üìÑ G√©n√©ration des bilans</h2>
                    <p>Cr√©ez les PDF individuels et les exports de classe</p>
                </div>

                <div class="generate-grid">
                    <!-- Bilans individuels -->
                    <div class="generate-card">
                        <div class="generate-icon">üë§</div>
                        <h3>Bilans individuels</h3>
                        <p>Un PDF par √©l√®ve avec note, comp√©tences et grille des questions trait√©es</p>
                        <div class="generate-buttons">
                            <button class="btn-primary" onclick="generateAllIndividualPDF()">
                                üìÑ G√©n√©rer tous les PDF
                            </button>
                            <button class="btn-secondary" onclick="showIndividualSelector()">
                                Choisir un √©l√®ve
                            </button>
                        </div>
                    </div>

                    <!-- Bilans group√©s par classe -->
                    <div class="generate-card">
                        <div class="generate-icon">üìë</div>
                        <h3>Bilans group√©s</h3>
                        <p>2 bilans par page, id√©al pour l'impression et la distribution</p>
                        <div class="generate-buttons">
                            <button class="btn-primary" onclick="generateClassPDFGrouped()">
                                üìë PDF group√©s (2/page)
                            </button>
                        </div>
                    </div>

                    <!-- Bilan de classe -->
                    <div class="generate-card">
                        <div class="generate-icon">üìä</div>
                        <h3>R√©capitulatif classe</h3>
                        <p>Tableau avec statistiques et r√©partition des niveaux de ma√Ætrise</p>
                        <div class="generate-buttons">
                            <button class="btn-primary" onclick="generateClassPDF()">
                                üìä PDF r√©capitulatif
                            </button>
                            <button class="btn-secondary" onclick="exportClassExcel()">
                                üìó Export Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filtre classe pour g√©n√©ration -->
                <div class="generate-filter">
                    <label>G√©n√©rer pour :</label>
                    <div class="class-chips" id="classChips3">
                        <button class="chip active" data-class="all" onclick="selectClass('all')">Toutes les classes</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modale s√©lection individuelle -->
    <div class="modal-overlay" id="individualModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>S√©lectionner un √©l√®ve</h3>
                <button class="close-btn" onclick="closeIndividualModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchStudent" placeholder="Rechercher par nom ou num√©ro..." class="search-input">
                <div class="student-list" id="studentList"></div>
            </div>
        </div>
    </div>

    <!-- Modale aper√ßu PDF -->
    <div class="modal-overlay" id="pdfPreviewModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Aper√ßu du bilan</h3>
                <button class="close-btn" onclick="closePdfPreview()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="pdfPreviewContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePdfPreview()">Fermer</button>
                <button class="btn-primary" onclick="downloadCurrentPdf()">üì• T√©l√©charger PDF</button>
            </div>
        </div>
    </div>

    <script src="js/modules/bilansManager.js?v=20260117017"></script>
</body>
</html>
